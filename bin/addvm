#!/bin/bash

name=$(xkcdpass --numwords 2 --delimiter '-')
mac=$(printf '52:54:00:%02x:%02x:%02x\n' "$((RANDOM%256))" "$((RANDOM%256))" "$((RANDOM%256))")

virt-install --connect qemu:///system \
	--name "$name" \
	--memory 4096 \
	--events on_crash=restart \
	--vcpus 4 \
	--boot network,hd \
	--controller type=scsi,model=virtio-scsi \
	--disk size=50,target.bus=scsi,cache=none \
	--disk size=50,target.bus=scsi,cache=none \
	--disk size=50,target.bus=scsi,cache=none \
	--disk size=50,target.bus=scsi,cache=none \
	--network bridge=maasbr0,model=virtio,mac="$mac" \
	--noautoconsole

if [ "$?" -eq 0 ]; then
	maas "$(hostname -s)" machines create hostname="$name" mac_addresses="$mac" architecture=amd64 power_type=manual
fi

if [ "$?" -eq 0 ]; then
	printf "\n$name\n"
fi
