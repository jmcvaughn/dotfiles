#!/bin/bash

generate_mac() {
	printf '52:54:00:%02x:%02x:%02x\n' "$((RANDOM%256))" "$((RANDOM%256))" "$((RANDOM%256))"
}

name=$(xkcdpass --numwords 2 --delimiter '-')
mac=$(generate_mac)

virt-install --connect qemu:///system \
	--name "$name" \
	--memory 6144 \
	--events on_crash=restart \
	--vcpus 6 \
	--boot network,hd \
	--controller type=scsi,model=virtio-scsi \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--disk size=200,format=raw,target.bus=scsi,cache=none,driver.io=native \
	--network bridge=maasbr0,model=virtio,mac="$mac" \
	--network bridge=maasbr0,model=virtio,mac="$(generate_mac)" \
	--noautoconsole

if [ "$?" -eq 0 ]; then
	maas "$(hostname -s)" machines create hostname="$name" mac_addresses="$mac" architecture=amd64 power_type=manual
fi

if [ "$?" -eq 0 ]; then
	printf "\n$name\n"
fi
